apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: arc-lambda
resources:
  - ../../../_base
namePrefix: lambda-
commonLabels:
  app: lambda
  rho2.identity: arc-lambda
patches:
  - target: { kind: Deployment, name: APPNAME }
    patch: |-
      - op: replace
        path: /metadata/name
        value: lambda
      - op: replace
        path: /spec/selector/matchLabels/app
        value: lambda
      - op: replace
        path: /spec/template/metadata/labels/app
        value: lambda
      - op: replace
        path: /spec/template/spec/containers/0/name
        value: lambda
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: silentsage432/lambda-worker:prod
      - op: replace
        path: /spec/template/spec/containers/1/name
        value: lambda-leaf
      - op: replace
        path: /spec/template/spec/volumes/0/configMap/name
        value: lambda-leaf-config
  - target: { kind: ConfigMap, name: APPNAME-leaf-config }
    patch: |-
      - op: replace
        path: /metadata/name
        value: lambda-leaf-config
      - op: replace
        path: /data/nats.conf
        value: |
          port: 4222
          server_name: "lambda-leaf"
          leafnodes { remotes = [ { url: "nats://${NATS_USER}:${NATS_PASS}@${CHI_HOST}:${CHI_LEAF_PORT}" } ] }
  - target: { kind: CiliumNetworkPolicy, name: APPNAME-egress }
    patch: |-
      - op: replace
        path: /metadata/name
        value: lambda-egress
      - op: replace
        path: /spec/endpointSelector/matchLabels/app
        value: lambda
images:
  - name: REPLACE_APP_IMAGE
    newName: silentsage432/lambda-worker
    newTag: prod
configMapGenerator: []
