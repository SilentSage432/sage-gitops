apiVersion: apps/v1
kind: Deployment
metadata:
  name: observer-api
  namespace: arc-zeta
spec:
  replicas: 1
  selector:
    matchLabels: { app: observer-api }
  template:
    metadata:
      labels: { app: observer-api }
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        seccompProfile: { type: RuntimeDefault }
      containers:
      - name: api
        image: python:3.12-slim
        ports: [ { containerPort: 8000, name: http } ]
        command: ["/bin/sh","-lc"]
        args:
          - |
            pip install --no-cache-dir fastapi uvicorn[standard] nats-py && \
            uvicorn app:app --host 0.0.0.0 --port 8000
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        volumeMounts:
          - { name: code, mountPath: /app, readOnly: true }
        workingDir: /app
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities: { drop: ["ALL"] }
        resources:
          requests: { cpu: "50m", memory: "128Mi" }
          limits:   { cpu: "400m", memory: "256Mi" }
      nodeSelector: { kubernetes.io/os: linux }
      tolerations:
        - { key: "node-role.kubernetes.io/control-plane", operator: "Exists", effect: "NoSchedule" }
      volumes:
        - name: code
          configMap: { name: observer-api-code }
